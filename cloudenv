#!/usr/bin/env bash
# This script was generated by bashly (https://github.com/DannyBen/bashly)
# Modifying it manually is not recommended

# :command.version_command
version_command() {
  echo "$version"
}

# :command.usage
cloudenv_usage() {
  if [[ -n $long_usage ]]; then
    printf "cloudenv - CloudEnv\n"
    echo 
  else
    printf "cloudenv - CloudEnv\n"
    echo 
  fi

  printf "Usage:\n"
  printf "  cloudenv [command]\n"
  printf "  cloudenv [command] --help | -h\n"
  printf "  cloudenv --version | -v\n"
  echo
  # :command.usage_commands
  printf "Commands:\n"
  echo "  login     Login to CloudEnv service"
  echo "  init      Initialize a new project"
  echo "  merge     Merge into CloudEnv"
  echo "  edit      Edit an environmental variable file"
  echo "  show      Show an environmental variable file"
  echo "  push      Push an existing environmental variable file"
  echo "  run       Run a command using some environmental variables"
  echo "  upgrade   Upgrade the cloudenv cli"
  echo

  if [[ -n $long_usage ]]; then
    printf "Options:\n"
    # :command.usage_fixed_flags
    echo "  --help, -h"
    printf "    Show this help\n"
    echo
    echo "  --version, -v"
    printf "    Show version number\n"
    echo

    # :command.usage_environment_variables
    printf "Environment Variables:\n"
    
    # :environment_variable.usage
    echo "  API_KEY"
    printf "    Set your API key\n"
    echo

  fi
}

# :command.usage
cloudenv_login_usage() {
  if [[ -n $long_usage ]]; then
    printf "cloudenv login - Login to CloudEnv service\n"
    echo 
  else
    printf "cloudenv login - Login to CloudEnv service\n"
    echo 
  fi

  printf "Shortcut: l\n"
  echo

  printf "Usage:\n"
  printf "  cloudenv login\n"
  printf "  cloudenv login --help | -h\n"
  echo

  if [[ -n $long_usage ]]; then
    printf "Options:\n"
    # :command.usage_fixed_flags
    echo "  --help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_examples
    printf "Examples:\n"
    
    printf "  cloudenv login\n"
    echo

  fi
}

# :command.usage
cloudenv_init_usage() {
  if [[ -n $long_usage ]]; then
    printf "cloudenv init - Initialize a new project\n"
    echo 
  else
    printf "cloudenv init - Initialize a new project\n"
    echo 
  fi

  printf "Shortcut: i\n"
  echo

  printf "Usage:\n"
  printf "  cloudenv init [options]\n"
  printf "  cloudenv init --help | -h\n"
  echo

  if [[ -n $long_usage ]]; then
    printf "Options:\n"
    # :command.usage_fixed_flags
    echo "  --help, -h"
    printf "    Show this help\n"
    echo
    # :command.usage_flags
    # :flag.usage
    echo "  --name, -n NAME"
    printf "    Name of the project\n"
    echo

  fi
}

# :command.usage
cloudenv_merge_usage() {
  if [[ -n $long_usage ]]; then
    printf "cloudenv merge - Merge into CloudEnv\n"
    echo 
  else
    printf "cloudenv merge - Merge into CloudEnv\n"
    echo 
  fi

  printf "Shortcut: m\n"
  echo

  printf "Usage:\n"
  printf "  cloudenv merge ENVIRONMENT FILENAME\n"
  printf "  cloudenv merge --help | -h\n"
  echo

  if [[ -n $long_usage ]]; then
    printf "Options:\n"
    # :command.usage_fixed_flags
    echo "  --help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_args
    printf "Arguments:\n"
    
    # :argument.usage
    echo "  ENVIRONMENT"
    printf "    Which environment should these variables be accessible in\n"
    echo
    
    # :argument.usage
    echo "  FILENAME"
    printf "    Target filename of existing env file\n"
    echo

    # :command.usage_examples
    printf "Examples:\n"
    
    printf "  cloudenv merge default .env\n"
    printf "  cloudenv merge development .env.dev\n"
    echo

  fi
}

# :command.usage
cloudenv_edit_usage() {
  if [[ -n $long_usage ]]; then
    printf "cloudenv edit - Edit an environmental variable file\n"
    echo 
  else
    printf "cloudenv edit - Edit an environmental variable file\n"
    echo 
  fi

  printf "Shortcut: e\n"
  echo

  printf "Usage:\n"
  printf "  cloudenv edit [ENVIRONMENT]\n"
  printf "  cloudenv edit --help | -h\n"
  echo

  if [[ -n $long_usage ]]; then
    printf "Options:\n"
    # :command.usage_fixed_flags
    echo "  --help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_args
    printf "Arguments:\n"
    
    # :argument.usage
    echo "  ENVIRONMENT"
    printf "    Which environment should these variables be accessible in\n"
    printf "    Default: default\n"
    echo

  fi
}

# :command.usage
cloudenv_show_usage() {
  if [[ -n $long_usage ]]; then
    printf "cloudenv show - Show an environmental variable file\n"
    echo 
  else
    printf "cloudenv show - Show an environmental variable file\n"
    echo 
  fi

  printf "Shortcut: s\n"
  echo

  printf "Usage:\n"
  printf "  cloudenv show [ENVIRONMENT]\n"
  printf "  cloudenv show --help | -h\n"
  echo

  if [[ -n $long_usage ]]; then
    printf "Options:\n"
    # :command.usage_fixed_flags
    echo "  --help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_args
    printf "Arguments:\n"
    
    # :argument.usage
    echo "  ENVIRONMENT"
    printf "    Which environment should these variables be accessible in\n"
    printf "    Default: default\n"
    echo

  fi
}

# :command.usage
cloudenv_push_usage() {
  if [[ -n $long_usage ]]; then
    printf "cloudenv push - Push an existing environmental variable file\n"
    echo 
  else
    printf "cloudenv push - Push an existing environmental variable file\n"
    echo 
  fi

  printf "Shortcut: p\n"
  echo

  printf "Usage:\n"
  printf "  cloudenv push [ENVIRONMENT] [FILE]\n"
  printf "  cloudenv push --help | -h\n"
  echo

  if [[ -n $long_usage ]]; then
    printf "Options:\n"
    # :command.usage_fixed_flags
    echo "  --help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_args
    printf "Arguments:\n"
    
    # :argument.usage
    echo "  ENVIRONMENT"
    printf "    Which environment should these variables be accessible in\n"
    printf "    Default: default\n"
    echo
    
    # :argument.usage
    echo "  FILE"
    printf "    Which file should be pushed\n"
    echo

    # :command.usage_examples
    printf "Examples:\n"
    
    printf "  cloudenv push default .env\n"
    printf "  cloudenv push staging .env.staging\n"
    printf "  cloudenv push production .env.production\n"
    echo

  fi
}

# :command.usage
cloudenv_run_usage() {
  if [[ -n $long_usage ]]; then
    printf "cloudenv run - Run a command using some environmental variables\n"
    echo 
  else
    printf "cloudenv run - Run a command using some environmental variables\n"
    echo 
  fi

  printf "Shortcut: r\n"
  echo

  printf "Usage:\n"
  printf "  cloudenv run [ENVIRONMENT] [COMMAND]\n"
  printf "  cloudenv run --help | -h\n"
  echo

  if [[ -n $long_usage ]]; then
    printf "Options:\n"
    # :command.usage_fixed_flags
    echo "  --help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_args
    printf "Arguments:\n"
    
    # :argument.usage
    echo "  ENVIRONMENT"
    printf "    Which environment should these variables be accessible in\n"
    printf "    Default: default\n"
    echo
    
    # :argument.usage
    echo "  COMMAND"
    printf "    Name of the command to start\n"
    printf "    Default: default\n"
    echo

    # :command.usage_examples
    printf "Examples:\n"
    
    printf "  cloudenv run default your-app-cli-start-command\n"
    printf "  cloudenv run staging your-app-cli-start-command\n"
    printf "  cloudenv run production your-app-cli-start-command\n"
    echo

  fi
}

# :command.usage
cloudenv_upgrade_usage() {
  if [[ -n $long_usage ]]; then
    printf "cloudenv upgrade - Upgrade the cloudenv cli\n"
    echo 
  else
    printf "cloudenv upgrade - Upgrade the cloudenv cli\n"
    echo 
  fi

  printf "Shortcut: u\n"
  echo

  printf "Usage:\n"
  printf "  cloudenv upgrade\n"
  printf "  cloudenv upgrade --help | -h\n"
  echo

  if [[ -n $long_usage ]]; then
    printf "Options:\n"
    # :command.usage_fixed_flags
    echo "  --help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_examples
    printf "Examples:\n"
    
    printf "  cloudenv upgrade\n"
    echo

  fi
}

# :command.inspect_args
inspect_args() {
  echo args:
  for k in "${!args[@]}"; do echo "- \${args[$k]} = ${args[$k]}"; done
}

# :command.command_functions
# :command.function
cloudenv_login_command() {
  # :src/login_command.sh
  echo "-----BEGIN PGP PUBLIC KEY BLOCK-----
  
  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
  =YJ9q
  -----END PGP PUBLIC KEY BLOCK-----" > /tmp/cloudenv.pub
  
  yes | gpg --import /tmp/cloudenv.pub &> /dev/null
  rm /tmp/cloudenv.pub
  hostname > ~/.cloudenvrc
  base64 < /dev/urandom | tr -d 'O0Il1+/' | head -c 256 | tr '\n' '1' >> ~/.cloudenvrc
  echo >> ~/.cloudenvrc
  gpg --encrypt --always-trust --armor --recipient support@cloudenv.com --no-version < ~/.cloudenvrc > /tmp/cloudenv.auth
  curl -s -F "data=@/tmp/cloudenv.auth" "$BASE_URL/initauth" > /tmp/cloudenv.auth-url
  rm /tmp/cloudenv.auth
  
  echo
  echo "Please visit this url and login or register to authorize this computer: "
  echo
  cat /tmp/cloudenv.auth-url
  echo
  echo
  
  data=0
  i=0
  
  while [[ $data == ?(-)+([0-9]) ]] && [ $i -lt 100 ]
  do
    i=$((i+1))
    data=`curl -s -F "data=@$HOME/.cloudenvrc" "$BASE_URL/checkauth"`
    sleep 2
  done
  
  if [[ $data == ?(-)+([0-9]) ]]
  then
    echo "Login failed, please try again"
    echo
  else
    read -ra ADDR <<< "$data"
    email="${ADDR[0]}"
    token="${ADDR[1]}"
    echo $token > ~/.cloudenvrc
    echo "You are now logged in as $email"
    echo
  fi
}

# :command.function
cloudenv_init_command() {
  # :src/init_command.sh
  if [ ! -f ~/.cloudenvrc ]
  then
  	echo
  	echo "Not logged in"
  	echo
  	echo "Please run: cloudenv login"
  	echo
  	exit
  fi
  
  bearer=`cat ~/.cloudenvrc | tr -d " \t\n\r"`
  
  if [ -f .cloudenv-secret-key ]
  then
  	name=`head -1 .cloudenv-secret-key`
  	secretkey=`tail -1 .cloudenv-secret-key`
  	environment="default"
  	echo "Already found an existing CloudEnv project in $PWD/.cloudenv-secret-key"
  	echo
  	read -p "Generate a new secret key for this project? (N/y): " newkey
  	if [ "$newkey" == "y" ]
  	then
  		curl -s -H "Authorization: Bearer $bearer" "$BASE_URL/api/v1/envs?app=$name&environment=$environment" > /tmp/cloudenv-edit
  		if [ -s /tmp/cloudenv-edit ]
  		then
  			openssl enc -aes-256-cbc -md sha512 -d -pass pass:"$secretkey" -in /tmp/cloudenv-edit -out /tmp/cloudenv-edit-decrypted
  			head -1 .cloudenv-secret-key > .cloudenv-secret-key-new
  			base64 < /dev/urandom | tr -d 'O0Il1+/' | head -c 256 | tr '\n' '1' >> .cloudenv-secret-key-new
  			echo >> .cloudenv-secret-key-new
  			mv .cloudenv-secret-key-new .cloudenv-secret-key
  			sha=`openssl dgst -sha256 .cloudenv-secret-key`
  		    read -ra ADDR <<< "$sha"
  			app=`curl -s -H "Authorization: Bearer $bearer" "$BASE_URL/api/v1/apps?name=$name&sha=${ADDR[1]}"`
  			secretkey=`tail -1 .cloudenv-secret-key`
  			openssl enc -aes-256-cbc -md sha512 -pass pass:"$secretkey" -in /tmp/cloudenv-edit-decrypted -out /tmp/cloudenv-edit
  			curl -s -H "Authorization: Bearer $bearer" -F "data=@/tmp/cloudenv-edit" "$BASE_URL/api/v1/envs?app=$name&environment=$environment"
  		else
  			echo "Couldn't find this app in CloudEnv, try deleting $PWD/.cloudenv-secret-key and starting over"
  			exit
  		fi
  		rm /tmp/cloudenv-edit*
  		if [ "$app" != 200 ]
  		then
  			echo
  			echo "ERROR ($app): I'm sorry but you do not have access to this app. If you believe this is in error, please contact another team member."
  		else
  			echo
  			echo "SUCCESS: New encryption key generated"
  			echo
  			echo "You need to distribute $PWD/.cloudenv-secret-key to all your team members and servers"
  		fi
  	fi
  else
  	read -p "Name of App: " name
  	# first, strip dashes
  	slug=${name//-/}
  	# next, replace spaces with underscores
  	slug=${slug// /-}
  	# now, clean out anything that's not alphanumeric or an underscore
  	slug=${slug//[^a-zA-Z0-9\-]/}
  	# finally, lowercase with TR
  	slug=`echo -n $slug | tr A-Z a-z`
  
  	app=`curl -s --data-urlencode "slug=$clean" --data-urlencode "name=$name" -H "Authorization: Bearer $bearer" "$BASE_URL/api/v1/apps"`
  	if [ "$app" == 401 ]
  	then
  		echo
  		echo "ERROR (401): This app name already exists, please choose a different one and try again."
  		exit
  	fi
  	if [ "$app" == 200 ]
  	then
  		echo
  		echo "ERROR (200): This app name already exists."
  		echo
  		echo "To get access to the variables, you must get a copy of .cloudenv-secret-key from a team member into this directory"
  		echo
  		exit
  	fi
  	echo $slug > .cloudenv-secret-key
  	base64 < /dev/urandom | tr -d 'O0Il1+/' | head -c 256 | tr '\n' '1' >> .cloudenv-secret-key
  	echo >> .cloudenv-secret-key
  	sha=`openssl dgst -sha256 .cloudenv-secret-key`
    read -ra ADDR <<< "$sha"
  	curl -s -H "Authorization: Bearer $bearer" "$BASE_URL/api/v1/apps?name=$name&sha=${ADDR[1]}" > /tmp/cloudenv-app
  	if [ "$app" == 201 ]
  	then
  		echo
  		echo "SUCCESS: You have created the app '$name' in CloudEnv"
  		echo
  		echo "You need to distribute $PWD/.cloudenv-secret-key to all your team members and servers"
  	else
  		if [ "$app" == 401 ]
  		then
  			echo
  			echo "ERROR ($app): Authentication error. Please run: cloudenv login"
  			exit
  		else
  			if [ "$app" == 404 ]
  			then
  				echo
  				echo "ERROR ($app): The CLI does not yet support accounts that are part of multiple organizations, please create this app at app.cloudenv.com"
  				exit
  			else
  				echo
  				echo "ERROR ($app): There was a problem, please try to create the app at app.cloudenv.com"
  				exit
  			fi
  		fi
  	fi
  fi
}

# :command.function
cloudenv_merge_command() {
  # :src/merge_command.sh
  echo "# this file is located in 'src/merge_command.sh'"
  echo "# code for 'cloudenv merge' goes here"
  echo "# you can edit it freely and regenerate (it will not be overwritten)"
  inspect_args
}

# :command.function
cloudenv_edit_command() {
  # :src/edit_command.sh
  if [ ! -f ~/.cloudenvrc ]
  then
  	echo
  	echo "Not logged in"
  	echo
  	echo "Please run: cloudenv login"
  	echo
  	exit
  fi
  
  if [ ! -f .cloudenv-secret-key ]
  then
  	echo
  	echo "Couldn't find a cloudenv project in $PWD/.cloudenv-secret-key"
  	echo
  	echo "Please run: cloudenv init"
  	echo
  	echo "Or cd into the root directory of your app to make env edits"
  	echo
  	exit
  fi
  
  tempdir=${CLOUDENV_TMPDIR:-`mktemp -d ~/.tmp.XXXXXXXX`}
  editor="${EDITOR:-nano}"
  bearer=`cat ~/.cloudenvrc | tr -d " \t\n\r"`
  app=`head -1 .cloudenv-secret-key`
  secretkey=`tail -1 .cloudenv-secret-key`
  environment="${args[environment]}"
  
  curl -s -H "Authorization: Bearer $bearer" "$BASE_URL/api/v1/envs?name=$app&environment=$environment" > "$tempdir/cloudenv-edit-$environment-encrypted"
  
  if [ -s "$tempdir/cloudenv-edit-$environment-encrypted" ]
  then
  	openssl enc -a -aes-256-cbc -md sha512 -d -pass pass:"$secretkey" -in "$tempdir/cloudenv-edit-$environment-encrypted" -out "$tempdir/cloudenv-edit-$environment" 2> /dev/null
  else
  	touch "$tempdir/cloudenv-edit-$environment"
  fi
  
  cp "$tempdir/cloudenv-edit-$environment" "$tempdir/cloudenv-orig-$environment"
  "$editor" "$tempdir/cloudenv-edit-$environment"
  
  if cmp --silent "$tempdir/cloudenv-edit-$environment" "$tempdir/cloudenv-orig-$environment"
  then
  	echo "No changes detected"
  else
  	openssl enc -a -aes-256-cbc -md sha512 -pass pass:"$secretkey" -in "$tempdir/cloudenv-edit-$environment" -out "$tempdir/cloudenv-edit-$environment-encrypted" 2> /dev/null
  
  	curl -s -H "Authorization: Bearer $bearer" -F "data=@$tempdir/cloudenv-edit-$environment-encrypted" "$BASE_URL/api/v1/envs?name=$app&environment=$environment" > /dev/null
  fi
  
  rm -rf "$tempdir"
}

# :command.function
cloudenv_show_command() {
  # :src/show_command.sh
  if [ ! -f ~/.cloudenvrc ]
  then
  	echo
  	echo "Not logged in"
  	echo
  	echo "Please run: cloudenv login"
  	echo
  	exit
  fi
  
  if [ ! -f .cloudenv-secret-key ]
  then
  	echo
  	echo "Couldn't find a cloudenv project in $PWD/.cloudenv-secret-key"
  	echo
  	echo "Please run: cloudenv init"
  	echo
  	echo "Or cd into the root directory of your app to make env edits"
  	echo
  	exit
  fi
  
  bearer=`cat ~/.cloudenvrc | tr -d " \t\n\r"`
  app=`head -1 .cloudenv-secret-key`
  secretkey=`tail -1 .cloudenv-secret-key`
  environment="${args[environment]}"
  tempdir="$(mktemp -d ~/.tmp.XXXXXXXX)"
  
  if [ "$environment" != "default" ]
  then
  	curl -s -H "Authorization: Bearer $bearer" "$BASE_URL/api/v1/envs?name=$app&environment=default" > "$tempdir/cloudenv-show-default-encrypted"
  
  	if [ -s "$tempdir/cloudenv-show-default-encrypted" ]
  	then
  		openssl enc -a -aes-256-cbc -md sha512 -d -pass pass:"$secretkey" -in "$tempdir/cloudenv-show-default-encrypted" 2> /dev/null
  	fi
  fi
  
  curl -s -H "Authorization: Bearer $bearer" "$BASE_URL/api/v1/envs?name=$app&environment=$environment" > "$tempdir/cloudenv-show-$environment-encrypted"
  
  if [ -s "$tempdir/cloudenv-show-$environment-encrypted" ]
  then
  	openssl enc -a -aes-256-cbc -md sha512 -d -pass pass:"$secretkey" -in "$tempdir/cloudenv-show-$environment-encrypted" 2> /dev/null
  fi
  
  rm -rf "$tempdir"
}

# :command.function
cloudenv_push_command() {
  # :src/push_command.sh
  if [ ! -f ~/.cloudenvrc ]
  then
  	echo
  	echo "Not logged in"
  	echo
  	echo "Please run: cloudenv login"
  	echo
  	exit
  fi
  
  if [ ! -f .cloudenv-secret-key ]
  then
  	echo
  	echo "Couldn't find a cloudenv project in $PWD/.cloudenv-secret-key"
  	echo
  	echo "Please run: cloudenv init"
  	echo
  	echo "Or cd into the root directory of your app to make env edits"
  	echo
  	exit
  fi
  
  bearer=`cat ~/.cloudenvrc | tr -d " \t\n\r"`
  app=`head -1 .cloudenv-secret-key`
  secretkey=`tail -1 .cloudenv-secret-key`
  environment="${args[environment]}"
  file="${args[file]}"
  tempdir="$(mktemp -d ~/.tmp.XXXXXXXX)"
  
  if [ -f "$file" ]
  then
  	openssl enc -a -aes-256-cbc -md sha512 -pass pass:"$secretkey" -in "$file" -out "$tempdir/cloudenv-edit-$environment-encrypted" 2> /dev/null
  	curl -s -H "Authorization: Bearer $bearer" -F "data=@$tempdir/cloudenv-edit-$environment-encrypted" "$BASE_URL/api/v1/envs?name=$app&environment=$environment" > /dev/null
  else
  	echo "File $file does not exist"
  fi
  
  rm -rf "$tempdir"
}

# :command.function
cloudenv_run_command() {
  # :src/run_command.sh
  if [ ! -f ~/.cloudenvrc ]
  then
  	echo
  	echo "Not logged in"
  	echo
  	echo "Please run: cloudenv login"
  	echo
  	exit
  fi
  
  if [ ! -f .cloudenv-secret-key ]
  then
  	echo
  	echo "Couldn't find a cloudenv project in $PWD/.cloudenv-secret-key"
  	echo
  	echo "Please run: cloudenv init"
  	echo
  	echo "Or cd into the root directory of your app to make env edits"
  	echo
  	exit
  fi
  
  editor="${EDITOR:-nano}"
  bearer=`cat ~/.cloudenvrc | tr -d " \t\n\r"`
  app=`head -1 .cloudenv-secret-key`
  secretkey=`tail -1 .cloudenv-secret-key`
  environment="${args[environment]}"
  command="${args[command]}"
  tempdir="$(mktemp -d ~/.tmp.XXXXXXXX)"
  
  curl -s -H "Authorization: Bearer $bearer" "$BASE_URL/api/v1/envs?name=$app&environment=$environment" > "$tempdir/cloudenv-edit-$environment-encrypted"
  
  if [ -s "$tempdir/cloudenv-edit-$environment-encrypted" ]
  then
  	openssl enc -a -aes-256-cbc -md sha512 -d -pass pass:"$secretkey" -in "$tempdir/cloudenv-edit-$environment-encrypted" -out "$tempdir/cloudenv-edit-$environment" 2> /dev/null
  	bash -c "source '$tempdir/cloudenv-edit-$environment'; rm -rf $tempdir; $command"
  else
  	bash -c "$command"
  fi
  
  rm -rf "$tempdir"
}

# :command.function
cloudenv_upgrade_command() {
  # :src/upgrade_command.sh
  bash -c "$(curl -fsSL https://app.cloudenv.com/install.sh)"
}

# :command.parse_requirements
parse_requirements() {
  # :command.fixed_flag_filter
  case "$1" in
  --version | -v )
    version_command
    exit
    ;;
  
  --help | -h )
    long_usage=yes
    cloudenv_usage
    exit 1
    ;;
  
  esac
  # :command.environment_variables_filter
  # :command.dependencies_filter
  # :command.command_filter
  action=$1
  
  case $action in
  -* )
    ;;
  
  login | l )
    action="login"
    shift
    cloudenv_login_parse_requirements "$@"
    shift $#
    ;;    
  
  init | i )
    action="init"
    shift
    cloudenv_init_parse_requirements "$@"
    shift $#
    ;;    
  
  merge | m )
    action="merge"
    shift
    cloudenv_merge_parse_requirements "$@"
    shift $#
    ;;    
  
  edit | e )
    action="edit"
    shift
    cloudenv_edit_parse_requirements "$@"
    shift $#
    ;;    
  
  show | s )
    action="show"
    shift
    cloudenv_show_parse_requirements "$@"
    shift $#
    ;;    
  
  push | p )
    action="push"
    shift
    cloudenv_push_parse_requirements "$@"
    shift $#
    ;;    
  
  run | r )
    action="run"
    shift
    cloudenv_run_parse_requirements "$@"
    shift $#
    ;;    
  
  upgrade | u )
    action="upgrade"
    shift
    cloudenv_upgrade_parse_requirements "$@"
    shift $#
    ;;    
  
  * )
    cloudenv_usage
    exit 1
    ;;
  
  esac
  # :command.required_args_filter
  # :command.required_flags_filter
  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
  
    -* )
      printf "invalid option: %s\n" "$key"
      exit 1
      ;;
  
    * )
      # :command.parse_requirements_case
      printf "invalid argument: %s\n" "$key"
      exit 1
      ;;
  
    esac
  done
  # :command.default_assignments
}

# :command.parse_requirements
cloudenv_login_parse_requirements() {
  # :command.fixed_flag_filter
  case "$1" in
  --version | -v )
    version_command
    exit
    ;;
  
  --help | -h )
    long_usage=yes
    cloudenv_login_usage
    exit 1
    ;;
  
  esac
  # :command.environment_variables_filter
  # :command.dependencies_filter
  # :command.command_filter
  action="login"
  # :command.required_args_filter
  # :command.required_flags_filter
  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
  
    -* )
      printf "invalid option: %s\n" "$key"
      exit 1
      ;;
  
    * )
      # :command.parse_requirements_case
      printf "invalid argument: %s\n" "$key"
      exit 1
      ;;
  
    esac
  done
  # :command.default_assignments
}

# :command.parse_requirements
cloudenv_init_parse_requirements() {
  # :command.fixed_flag_filter
  case "$1" in
  --version | -v )
    version_command
    exit
    ;;
  
  --help | -h )
    long_usage=yes
    cloudenv_init_usage
    exit 1
    ;;
  
  esac
  # :command.environment_variables_filter
  # :command.dependencies_filter
  # :command.command_filter
  action="init"
  # :command.required_args_filter
  # :command.required_flags_filter
  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
    # :flag.case
    --name | -n )
      if [[ $2 && $2 != -* ]]; then
        args[--name]="$2"
        shift
        shift
      else
        printf "%s\n" "--name requires an argument: --name, -n NAME"
        exit 1
      fi
      ;;
  
  
    -* )
      printf "invalid option: %s\n" "$key"
      exit 1
      ;;
  
    * )
      # :command.parse_requirements_case
      printf "invalid argument: %s\n" "$key"
      exit 1
      ;;
  
    esac
  done
  # :command.default_assignments
}

# :command.parse_requirements
cloudenv_merge_parse_requirements() {
  # :command.fixed_flag_filter
  case "$1" in
  --version | -v )
    version_command
    exit
    ;;
  
  --help | -h )
    long_usage=yes
    cloudenv_merge_usage
    exit 1
    ;;
  
  esac
  # :command.environment_variables_filter
  # :command.dependencies_filter
  # :command.command_filter
  action="merge"
  # :command.required_args_filter
  if [[ $1 && $1 != -* ]]; then
    args[environment]=$1
    shift
  else
    printf "missing required argument: ENVIRONMENT\nusage: cloudenv merge ENVIRONMENT FILENAME\n"
    exit 1
  fi
  
  if [[ $1 && $1 != -* ]]; then
    args[filename]=$1
    shift
  else
    printf "missing required argument: FILENAME\nusage: cloudenv merge ENVIRONMENT FILENAME\n"
    exit 1
  fi
  # :command.required_flags_filter
  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
  
    -* )
      printf "invalid option: %s\n" "$key"
      exit 1
      ;;
  
    * )
      # :command.parse_requirements_case
      if [[ ! ${args[environment]} ]]; then
        args[environment]=$1
        shift
      elif [[ ! ${args[filename]} ]]; then
        args[filename]=$1
        shift
      else
        printf "invalid argument: %s\n" "$key"
        exit 1
      fi
      ;;
  
    esac
  done
  # :command.default_assignments
}

# :command.parse_requirements
cloudenv_edit_parse_requirements() {
  # :command.fixed_flag_filter
  case "$1" in
  --version | -v )
    version_command
    exit
    ;;
  
  --help | -h )
    long_usage=yes
    cloudenv_edit_usage
    exit 1
    ;;
  
  esac
  # :command.environment_variables_filter
  # :command.dependencies_filter
  # :command.command_filter
  action="edit"
  # :command.required_args_filter
  # :command.required_flags_filter
  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
  
    -* )
      printf "invalid option: %s\n" "$key"
      exit 1
      ;;
  
    * )
      # :command.parse_requirements_case
      if [[ ! ${args[environment]} ]]; then
        args[environment]=$1
        shift
      else
        printf "invalid argument: %s\n" "$key"
        exit 1
      fi
      ;;
  
    esac
  done
  # :command.default_assignments
  [[ -n ${args[environment]} ]] || args[environment]="default"
}

# :command.parse_requirements
cloudenv_show_parse_requirements() {
  # :command.fixed_flag_filter
  case "$1" in
  --version | -v )
    version_command
    exit
    ;;
  
  --help | -h )
    long_usage=yes
    cloudenv_show_usage
    exit 1
    ;;
  
  esac
  # :command.environment_variables_filter
  # :command.dependencies_filter
  # :command.command_filter
  action="show"
  # :command.required_args_filter
  # :command.required_flags_filter
  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
  
    -* )
      printf "invalid option: %s\n" "$key"
      exit 1
      ;;
  
    * )
      # :command.parse_requirements_case
      if [[ ! ${args[environment]} ]]; then
        args[environment]=$1
        shift
      else
        printf "invalid argument: %s\n" "$key"
        exit 1
      fi
      ;;
  
    esac
  done
  # :command.default_assignments
  [[ -n ${args[environment]} ]] || args[environment]="default"
}

# :command.parse_requirements
cloudenv_push_parse_requirements() {
  # :command.fixed_flag_filter
  case "$1" in
  --version | -v )
    version_command
    exit
    ;;
  
  --help | -h )
    long_usage=yes
    cloudenv_push_usage
    exit 1
    ;;
  
  esac
  # :command.environment_variables_filter
  # :command.dependencies_filter
  # :command.command_filter
  action="push"
  # :command.required_args_filter
  # :command.required_flags_filter
  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
  
    -* )
      printf "invalid option: %s\n" "$key"
      exit 1
      ;;
  
    * )
      # :command.parse_requirements_case
      if [[ ! ${args[environment]} ]]; then
        args[environment]=$1
        shift
      elif [[ ! ${args[file]} ]]; then
        args[file]=$1
        shift
      else
        printf "invalid argument: %s\n" "$key"
        exit 1
      fi
      ;;
  
    esac
  done
  # :command.default_assignments
  [[ -n ${args[environment]} ]] || args[environment]="default"
}

# :command.parse_requirements
cloudenv_run_parse_requirements() {
  # :command.fixed_flag_filter
  case "$1" in
  --version | -v )
    version_command
    exit
    ;;
  
  --help | -h )
    long_usage=yes
    cloudenv_run_usage
    exit 1
    ;;
  
  esac
  # :command.environment_variables_filter
  # :command.dependencies_filter
  # :command.command_filter
  action="run"
  # :command.required_args_filter
  # :command.required_flags_filter
  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
  
    -* )
      printf "invalid option: %s\n" "$key"
      exit 1
      ;;
  
    * )
      # :command.parse_requirements_case
      if [[ ! ${args[environment]} ]]; then
        args[environment]=$1
        shift
      elif [[ ! ${args[command]} ]]; then
        args[command]=$1
        shift
      else
        printf "invalid argument: %s\n" "$key"
        exit 1
      fi
      ;;
  
    esac
  done
  # :command.default_assignments
  [[ -n ${args[environment]} ]] || args[environment]="default"
  [[ -n ${args[command]} ]] || args[command]="default"
}

# :command.parse_requirements
cloudenv_upgrade_parse_requirements() {
  # :command.fixed_flag_filter
  case "$1" in
  --version | -v )
    version_command
    exit
    ;;
  
  --help | -h )
    long_usage=yes
    cloudenv_upgrade_usage
    exit 1
    ;;
  
  esac
  # :command.environment_variables_filter
  # :command.dependencies_filter
  # :command.command_filter
  action="upgrade"
  # :command.required_args_filter
  # :command.required_flags_filter
  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
  
    -* )
      printf "invalid option: %s\n" "$key"
      exit 1
      ;;
  
    * )
      # :command.parse_requirements_case
      printf "invalid argument: %s\n" "$key"
      exit 1
      ;;
  
    esac
  done
  # :command.default_assignments
}

# :command.initialize
initialize() {
  version="0.1.0"
  long_usage=''
  set -e  

  # :src/initialize.sh
  # Code here runs inside the initialize() function
  # Use it for anything that you need to run before any other function, like
  # setting environment vairables:
  # CONFIG_FILE=settings.ini
  #
  # Feel free to empty (but not delete) this file.
  
  BASE_URL=${CLOUDENV_BASE_URL:-https://app.cloudenv.com}
}

# :command.run
run() {
  declare -A args
  parse_requirements "$@"

  if [[ $action == "login" ]]; then
    if [[ ${args[--help]} ]]; then
      long_usage=yes
      cloudenv_login_usage
    else
      cloudenv_login_command
    fi
  
  elif [[ $action == "init" ]]; then
    if [[ ${args[--help]} ]]; then
      long_usage=yes
      cloudenv_init_usage
    else
      cloudenv_init_command
    fi
  
  elif [[ $action == "merge" ]]; then
    if [[ ${args[--help]} ]]; then
      long_usage=yes
      cloudenv_merge_usage
    else
      cloudenv_merge_command
    fi
  
  elif [[ $action == "edit" ]]; then
    if [[ ${args[--help]} ]]; then
      long_usage=yes
      cloudenv_edit_usage
    else
      cloudenv_edit_command
    fi
  
  elif [[ $action == "show" ]]; then
    if [[ ${args[--help]} ]]; then
      long_usage=yes
      cloudenv_show_usage
    else
      cloudenv_show_command
    fi
  
  elif [[ $action == "push" ]]; then
    if [[ ${args[--help]} ]]; then
      long_usage=yes
      cloudenv_push_usage
    else
      cloudenv_push_command
    fi
  
  elif [[ $action == "run" ]]; then
    if [[ ${args[--help]} ]]; then
      long_usage=yes
      cloudenv_run_usage
    else
      cloudenv_run_command
    fi
  
  elif [[ $action == "upgrade" ]]; then
    if [[ ${args[--help]} ]]; then
      long_usage=yes
      cloudenv_upgrade_usage
    else
      cloudenv_upgrade_command
    fi
  
  elif [[ ${args[--version]} ]]; then
    version_command
  elif [[ ${args[--help]} ]]; then
    long_usage=yes
    cloudenv_usage
  elif [[ $action == "root" ]]; then
    root_command
  fi
}

initialize
run "$@"
